{"cells":[{"cell_type":"code","execution_count":null,"metadata":{"id":"G44dnwnNNVCb"},"outputs":[],"source":["#import findspark\n","#findspark.init()\n","\n","import pyspark\n","\n","from pyspark.sql import functions as f\n","from pyspark.sql import SparkSession, Window\n","from pyspark.sql.types import (StringType, IntegerType, FloatType, DecimalType, StructField, StructType)\n","\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"2iw7UCILPGtt"},"outputs":[],"source":["# Crear una sesión de Spark\n","\n","def init_spark():\n","    spark = SparkSession.builder.appName(\"proyecto\")\\\n","                .config(\"spark.driver.extraClassPath\", \"postgresql-42.2.14.jar\") \\\n","                .config(\"spark.executor.extraClassPath\", \"postgresql-42.2.14.jar\") \\\n","                .getOrCreate()\n","    sc =  spark.sparkContext\n","    return spark, sc\n"]},{"cell_type":"code","source":["def start_df(spark, data_schema, path, header=False):\n","    return spark.read.csv(path, schema=data_schema, header=header) if path else None"],"metadata":{"id":"GeV5nYBIN1lE"},"execution_count":null,"outputs":[]},{"cell_type":"code","execution_count":null,"metadata":{"id":"89o2W66ESguj"},"outputs":[],"source":["#inicia un DataFrame Spark a partir de un CSV\n","\n","def create_df(spark, data_schema, path):\n","    if path:\n","        df = spark.read.csv(path, schema=data_schema)\n","        return df\n","    else:\n","        return None"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"woWjPidkSicO"},"outputs":[],"source":["#extrae el nombre del archivo (sin extensión) a partir de una ruta de archivo\n","\n","def get_file_name(file_path):\n","    file_name_without_extension, _ = os.path.splitext(\n","        os.path.basename(file_path))\n","    return file_name_without_extension"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"9b4fRcoBY8B1"},"outputs":[],"source":["#Crea y devuelve un esquema según el nombre del archivo\n","\n","def create_schema(file_name):\n","    data_schema = None\n","\n","    if file_name == \"Credit_card\":\n","        data_schema = StructType([\n","            StructField(\"Ind_ID\", IntegerType(), True),\n","            StructField(\"GENDER\", StringType(), True),\n","            StructField(\"Car_Owner\", StringType(), True),\n","            StructField(\"Propert_Owner\", StringType(), True),\n","            StructField(\"CHILDREN\", IntegerType(), True),\n","            StructField(\"Annual_income\", FloatType(), True),\n","            StructField(\"Type_Income\", StringType(), True),\n","            StructField(\"EDUCATION\", StringType(), True),\n","            StructField(\"Marital_status\", StringType(), True),\n","            StructField(\"Housing_type\", StringType(), True),\n","            StructField(\"Birthday_count\", FloatType(), True),\n","            StructField(\"Employed_days\", IntegerType(), True),\n","            StructField(\"Mobile_phone\", IntegerType(), True),\n","            StructField(\"Work_Phone\", IntegerType(), True),\n","            StructField(\"Phone\", IntegerType(), True),\n","            StructField(\"EMAIL_ID\", IntegerType(), True),\n","            StructField(\"Type_Occupation\", StringType(), True),\n","            StructField(\"Family_Members\", IntegerType(), True)\n","        ])\n","\n","    elif file_name == \"Credit_card_label\":\n","        data_schema = StructType([\n","            StructField(\"Ind_ID\", IntegerType(), True),\n","            StructField(\"label\", IntegerType(), True)\n","        ])\n","\n","    return data_schema\n","\n","data_schema1 = create_schema(\"Credit_card\")\n","data_schema2 = create_schema(\"Credit_card_label\")"]},{"cell_type":"markdown","source":["# **Funciones para reemplazar valores faltantes**"],"metadata":{"id":"FLcMqgpySGpm"}},{"cell_type":"code","source":["#funcion para reemplazar valores faltanes por el valor modal del atributo \"GENDER\", \"CHILDREN\", \"Mobile_phone\", \"Work_Phone\", \"Family_Members\"\n","\n","from pyspark.sql.functions import when\n","\n","def impute_with_most_common(df, column):\n","    most_common_value = df.groupBy(column).count().orderBy(\"count\", ascending=False).first()[0]\n","    return df.withColumn(column, when(df[column].isNull(), most_common_value).otherwise(df[column]))\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"r4L3sZyNSBbR","executionInfo":{"status":"ok","timestamp":1704485946247,"user_tz":360,"elapsed":16523,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"09f6962f-c3de-48aa-ceb7-876df150265d"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+------+---------+-------------+--------+-------------+--------------------+--------------------+--------------------+-----------------+--------------+-------------+------------+----------+-----+--------+---------------+--------------+\n","| Ind_ID|GENDER|Car_Owner|Propert_Owner|CHILDREN|Annual_income|         Type_Income|           EDUCATION|      Marital_status|     Housing_type|Birthday_count|Employed_days|Mobile_phone|Work_Phone|Phone|EMAIL_ID|Type_Occupation|Family_Members|\n","+-------+------+---------+-------------+--------+-------------+--------------------+--------------------+--------------------+-----------------+--------------+-------------+------------+----------+-----+--------+---------------+--------------+\n","|5008827|     M|        Y|            Y|       0|     180000.0|           Pensioner|    Higher education|             Married|House / apartment|      -18772.0|       365243|           1|         0|    0|       0|           NULL|             2|\n","|5009744|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|           NULL|             2|\n","|5009746|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|          NULL|         -586|           1|         1|    1|       0|           NULL|             2|\n","|5009749|     F|        Y|            N|       0|         NULL|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|           NULL|             2|\n","|5009752|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|           NULL|             2|\n","|5009753|     F|        Y|            N|       0|     315000.0|           Pensioner|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|           NULL|             2|\n","|5009754|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|           NULL|             2|\n","|5009894|     F|        N|            N|       0|     180000.0|           Pensioner|Secondary / secon...|             Married|House / apartment|      -22134.0|       365243|           1|         0|    0|       0|           NULL|             2|\n","|5010864|     M|        Y|            Y|       1|     450000.0|Commercial associate|Secondary / secon...|             Married|House / apartment|      -18173.0|         -678|           1|         0|    1|       1|     Core staff|             3|\n","|5010868|     M|        Y|            Y|       1|     450000.0|           Pensioner|Secondary / secon...|             Married|House / apartment|      -18173.0|         -678|           1|         0|    1|       1|     Core staff|             3|\n","|5010869|     M|        Y|            Y|       1|     450000.0|Commercial associate|Secondary / secon...|Single / not married|House / apartment|      -18173.0|         -678|           1|         0|    1|       1|     Core staff|             1|\n","|5018498|     F|        Y|            Y|       0|      90000.0|             Working|Secondary / secon...|             Married|House / apartment|      -18950.0|        -1002|           1|         1|    1|       0|  Cooking staff|             2|\n","|5018501|     F|        Y|            Y|       0|         NULL|             Working|Secondary / secon...|             Married|House / apartment|      -18950.0|        -1002|           1|         1|    1|       0|  Cooking staff|             2|\n","|5018503|     F|        Y|            Y|       0|      90000.0|             Working|Secondary / secon...|             Married|House / apartment|      -18950.0|        -1002|           1|         1|    1|       0|  Cooking staff|             2|\n","|5021303|     M|        N|            N|       1|     472500.0|           Pensioner|    Higher education|             Married|     With parents|       -8907.0|         -913|           1|         0|    0|       1|           NULL|             3|\n","|5021310|     M|        N|            Y|       0|     270000.0|             Working|Secondary / secon...|             Married|House / apartment|      -16896.0|         -248|           1|         0|    0|       0|       Laborers|             2|\n","|5021314|     M|        N|            Y|       0|     270000.0|             Working|Secondary / secon...|Single / not married|House / apartment|      -16896.0|         -248|           1|         0|    0|       0|       Laborers|             2|\n","|5021430|     F|        N|            Y|       0|     126000.0|Commercial associate|    Higher education|Single / not married|House / apartment|      -18907.0|        -2470|           1|         0|    0|       0|    Sales staff|             1|\n","|5021431|     F|        N|            Y|       0|     126000.0|Commercial associate|    Higher education|Single / not married|House / apartment|      -18907.0|        -2470|           1|         0|    0|       0|    Sales staff|             1|\n","|5021998|     M|        N|            Y|       0|      90000.0|           Pensioner|Secondary / secon...|             Married|House / apartment|      -18863.0|        -1644|           1|         0|    0|       1|           NULL|             2|\n","+-------+------+---------+-------------+--------+-------------+--------------------+--------------------+--------------------+-----------------+--------------+-------------+------------+----------+-----+--------+---------------+--------------+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["#funcion para reemplazar valores faltanes por el nuevo valor \"Unknown\" del atributo\n","\n","def handle_missing_categorical_columns(df, columns):\n","    for column in columns:\n","        df = df.withColumn(column, when(df[column].isNull(), \"Unknown\").otherwise(df[column]))\n","    return df\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Nngie3cLUaou","executionInfo":{"status":"ok","timestamp":1704485950534,"user_tz":360,"elapsed":927,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"012d291a-db01-499c-e7cc-a8a7444f139c"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+------+---------+-------------+--------+-------------+--------------------+--------------------+--------------------+-----------------+--------------+-------------+------------+----------+-----+--------+---------------+--------------+\n","| Ind_ID|GENDER|Car_Owner|Propert_Owner|CHILDREN|Annual_income|         Type_Income|           EDUCATION|      Marital_status|     Housing_type|Birthday_count|Employed_days|Mobile_phone|Work_Phone|Phone|EMAIL_ID|Type_Occupation|Family_Members|\n","+-------+------+---------+-------------+--------+-------------+--------------------+--------------------+--------------------+-----------------+--------------+-------------+------------+----------+-----+--------+---------------+--------------+\n","|5008827|     M|        Y|            Y|       0|     180000.0|           Pensioner|    Higher education|             Married|House / apartment|      -18772.0|       365243|           1|         0|    0|       0|        Unknown|             2|\n","|5009744|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|        Unknown|             2|\n","|5009746|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|          NULL|         -586|           1|         1|    1|       0|        Unknown|             2|\n","|5009749|     F|        Y|            N|       0|         NULL|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|        Unknown|             2|\n","|5009752|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|        Unknown|             2|\n","|5009753|     F|        Y|            N|       0|     315000.0|           Pensioner|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|        Unknown|             2|\n","|5009754|     F|        Y|            N|       0|     315000.0|Commercial associate|    Higher education|             Married|House / apartment|      -13557.0|         -586|           1|         1|    1|       0|        Unknown|             2|\n","|5009894|     F|        N|            N|       0|     180000.0|           Pensioner|Secondary / secon...|             Married|House / apartment|      -22134.0|       365243|           1|         0|    0|       0|        Unknown|             2|\n","|5010864|     M|        Y|            Y|       1|     450000.0|Commercial associate|Secondary / secon...|             Married|House / apartment|      -18173.0|         -678|           1|         0|    1|       1|     Core staff|             3|\n","|5010868|     M|        Y|            Y|       1|     450000.0|           Pensioner|Secondary / secon...|             Married|House / apartment|      -18173.0|         -678|           1|         0|    1|       1|     Core staff|             3|\n","|5010869|     M|        Y|            Y|       1|     450000.0|Commercial associate|Secondary / secon...|Single / not married|House / apartment|      -18173.0|         -678|           1|         0|    1|       1|     Core staff|             1|\n","|5018498|     F|        Y|            Y|       0|      90000.0|             Working|Secondary / secon...|             Married|House / apartment|      -18950.0|        -1002|           1|         1|    1|       0|  Cooking staff|             2|\n","|5018501|     F|        Y|            Y|       0|         NULL|             Working|Secondary / secon...|             Married|House / apartment|      -18950.0|        -1002|           1|         1|    1|       0|  Cooking staff|             2|\n","|5018503|     F|        Y|            Y|       0|      90000.0|             Working|Secondary / secon...|             Married|House / apartment|      -18950.0|        -1002|           1|         1|    1|       0|  Cooking staff|             2|\n","|5021303|     M|        N|            N|       1|     472500.0|           Pensioner|    Higher education|             Married|     With parents|       -8907.0|         -913|           1|         0|    0|       1|        Unknown|             3|\n","|5021310|     M|        N|            Y|       0|     270000.0|             Working|Secondary / secon...|             Married|House / apartment|      -16896.0|         -248|           1|         0|    0|       0|       Laborers|             2|\n","|5021314|     M|        N|            Y|       0|     270000.0|             Working|Secondary / secon...|Single / not married|House / apartment|      -16896.0|         -248|           1|         0|    0|       0|       Laborers|             2|\n","|5021430|     F|        N|            Y|       0|     126000.0|Commercial associate|    Higher education|Single / not married|House / apartment|      -18907.0|        -2470|           1|         0|    0|       0|    Sales staff|             1|\n","|5021431|     F|        N|            Y|       0|     126000.0|Commercial associate|    Higher education|Single / not married|House / apartment|      -18907.0|        -2470|           1|         0|    0|       0|    Sales staff|             1|\n","|5021998|     M|        N|            Y|       0|      90000.0|           Pensioner|Secondary / secon...|             Married|House / apartment|      -18863.0|        -1644|           1|         0|    0|       1|        Unknown|             2|\n","+-------+------+---------+-------------+--------+-------------+--------------------+--------------------+--------------------+-----------------+--------------+-------------+------------+----------+-----+--------+---------------+--------------+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["#funcion para reemplazar valores faltanes por el valor promedio del atributo\n","\n","from pyspark.ml.feature import Imputer\n","\n","def impute_abs_negative_values(df, columns):\n","    for column in columns:\n","        # Tomar el valor absoluto directamente en la columna existente\n","        df = df.withColumn(column, f.abs(df[column]))\n","\n","        # Imputar valores faltantes directamente en la columna existente\n","        imputer = Imputer(inputCols=[column], outputCols=[f\"{column}_imputed\"], strategy=\"mean\")\n","        df = imputer.fit(df).transform(df)\n","\n","        df = df.drop(column)\n","\n","    return df\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"RjFvCgRCat2h","executionInfo":{"status":"ok","timestamp":1704485956522,"user_tz":360,"elapsed":4065,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"8a175b30-dca2-4d94-b445-8d16da49a726"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+------+---------+-------------+--------+--------------------+--------------------+--------------------+-----------------+-------------+------------+----------+-----+--------+---------------+--------------+---------------------+----------------------+\n","| Ind_ID|GENDER|Car_Owner|Propert_Owner|CHILDREN|         Type_Income|           EDUCATION|      Marital_status|     Housing_type|Employed_days|Mobile_phone|Work_Phone|Phone|EMAIL_ID|Type_Occupation|Family_Members|Annual_income_imputed|Birthday_count_imputed|\n","+-------+------+---------+-------------+--------+--------------------+--------------------+--------------------+-----------------+-------------+------------+----------+-----+--------+---------------+--------------+---------------------+----------------------+\n","|5008827|     M|        Y|            Y|       0|           Pensioner|    Higher education|             Married|House / apartment|       365243|           1|         0|    0|       0|        Unknown|             2|             180000.0|               18772.0|\n","|5009744|     F|        Y|            N|       0|Commercial associate|    Higher education|             Married|House / apartment|         -586|           1|         1|    1|       0|        Unknown|             2|             315000.0|               13557.0|\n","|5009746|     F|        Y|            N|       0|Commercial associate|    Higher education|             Married|House / apartment|         -586|           1|         1|    1|       0|        Unknown|             2|             315000.0|             16040.342|\n","|5009749|     F|        Y|            N|       0|Commercial associate|    Higher education|             Married|House / apartment|         -586|           1|         1|    1|       0|        Unknown|             2|            191399.33|               13557.0|\n","|5009752|     F|        Y|            N|       0|Commercial associate|    Higher education|             Married|House / apartment|         -586|           1|         1|    1|       0|        Unknown|             2|             315000.0|               13557.0|\n","|5009753|     F|        Y|            N|       0|           Pensioner|    Higher education|             Married|House / apartment|         -586|           1|         1|    1|       0|        Unknown|             2|             315000.0|               13557.0|\n","|5009754|     F|        Y|            N|       0|Commercial associate|    Higher education|             Married|House / apartment|         -586|           1|         1|    1|       0|        Unknown|             2|             315000.0|               13557.0|\n","|5009894|     F|        N|            N|       0|           Pensioner|Secondary / secon...|             Married|House / apartment|       365243|           1|         0|    0|       0|        Unknown|             2|             180000.0|               22134.0|\n","|5010864|     M|        Y|            Y|       1|Commercial associate|Secondary / secon...|             Married|House / apartment|         -678|           1|         0|    1|       1|     Core staff|             3|             450000.0|               18173.0|\n","|5010868|     M|        Y|            Y|       1|           Pensioner|Secondary / secon...|             Married|House / apartment|         -678|           1|         0|    1|       1|     Core staff|             3|             450000.0|               18173.0|\n","|5010869|     M|        Y|            Y|       1|Commercial associate|Secondary / secon...|Single / not married|House / apartment|         -678|           1|         0|    1|       1|     Core staff|             1|             450000.0|               18173.0|\n","|5018498|     F|        Y|            Y|       0|             Working|Secondary / secon...|             Married|House / apartment|        -1002|           1|         1|    1|       0|  Cooking staff|             2|              90000.0|               18950.0|\n","|5018501|     F|        Y|            Y|       0|             Working|Secondary / secon...|             Married|House / apartment|        -1002|           1|         1|    1|       0|  Cooking staff|             2|            191399.33|               18950.0|\n","|5018503|     F|        Y|            Y|       0|             Working|Secondary / secon...|             Married|House / apartment|        -1002|           1|         1|    1|       0|  Cooking staff|             2|              90000.0|               18950.0|\n","|5021303|     M|        N|            N|       1|           Pensioner|    Higher education|             Married|     With parents|         -913|           1|         0|    0|       1|        Unknown|             3|             472500.0|                8907.0|\n","|5021310|     M|        N|            Y|       0|             Working|Secondary / secon...|             Married|House / apartment|         -248|           1|         0|    0|       0|       Laborers|             2|             270000.0|               16896.0|\n","|5021314|     M|        N|            Y|       0|             Working|Secondary / secon...|Single / not married|House / apartment|         -248|           1|         0|    0|       0|       Laborers|             2|             270000.0|               16896.0|\n","|5021430|     F|        N|            Y|       0|Commercial associate|    Higher education|Single / not married|House / apartment|        -2470|           1|         0|    0|       0|    Sales staff|             1|             126000.0|               18907.0|\n","|5021431|     F|        N|            Y|       0|Commercial associate|    Higher education|Single / not married|House / apartment|        -2470|           1|         0|    0|       0|    Sales staff|             1|             126000.0|               18907.0|\n","|5021998|     M|        N|            Y|       0|           Pensioner|Secondary / secon...|             Married|House / apartment|        -1644|           1|         0|    0|       1|        Unknown|             2|              90000.0|               18863.0|\n","+-------+------+---------+-------------+--------+--------------------+--------------------+--------------------+-----------------+-------------+------------+----------+-----+--------+---------------+--------------+---------------------+----------------------+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"markdown","source":["# **Funciones para transformaciones de los datos**"],"metadata":{"id":"wnvb7iDldJGQ"}},{"cell_type":"code","execution_count":null,"metadata":{"id":"mi8MLTqmbXXn","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1704486164087,"user_tz":360,"elapsed":9162,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"cf5514f6-bf5f-4a22-fb56-527d303db310"},"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+--------+------------+----------+-----+--------+--------------+---------------------+----------------------+------------+---------------+-------------------+-----------------+---------------+--------------------+------------------+-------------------+---------------------+\n","| Ind_ID|CHILDREN|Mobile_phone|Work_Phone|Phone|EMAIL_ID|Family_Members|Annual_income_imputed|Birthday_count_imputed|GENDER_index|Car_Owner_index|Propert_Owner_index|Type_Income_index|EDUCATION_index|Marital_status_index|Housing_type_index|Employed_days_index|Type_Occupation_index|\n","+-------+--------+------------+----------+-----+--------+--------------+---------------------+----------------------+------------+---------------+-------------------+-----------------+---------------+--------------------+------------------+-------------------+---------------------+\n","|5008827|       0|           1|         0|    0|       0|             2|             180000.0|               18772.0|         1.0|            1.0|                0.0|              2.0|            1.0|                 0.0|               0.0|                0.0|                  0.0|\n","|5009744|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|\n","|5009746|       0|           1|         1|    1|       0|             2|             315000.0|             16040.342|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|\n","|5009749|       0|           1|         1|    1|       0|             2|            191399.33|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|\n","|5009752|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|\n","|5009753|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              2.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|\n","|5009754|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|\n","|5009894|       0|           1|         0|    0|       0|             2|             180000.0|               22134.0|         0.0|            0.0|                1.0|              2.0|            0.0|                 0.0|               0.0|                0.0|                  0.0|\n","|5010864|       1|           1|         0|    1|       1|             3|             450000.0|               18173.0|         1.0|            1.0|                0.0|              1.0|            0.0|                 0.0|               0.0|               17.0|                  2.0|\n","|5010868|       1|           1|         0|    1|       1|             3|             450000.0|               18173.0|         1.0|            1.0|                0.0|              2.0|            0.0|                 0.0|               0.0|               17.0|                  2.0|\n","|5010869|       1|           1|         0|    1|       1|             1|             450000.0|               18173.0|         1.0|            1.0|                0.0|              1.0|            0.0|                 1.0|               0.0|               17.0|                  2.0|\n","|5018498|       0|           1|         1|    1|       0|             2|              90000.0|               18950.0|         0.0|            1.0|                0.0|              0.0|            0.0|                 0.0|               0.0|               21.0|                 11.0|\n","|5018501|       0|           1|         1|    1|       0|             2|            191399.33|               18950.0|         0.0|            1.0|                0.0|              0.0|            0.0|                 0.0|               0.0|               21.0|                 11.0|\n","|5018503|       0|           1|         1|    1|       0|             2|              90000.0|               18950.0|         0.0|            1.0|                0.0|              0.0|            0.0|                 0.0|               0.0|               21.0|                 11.0|\n","|5021303|       1|           1|         0|    0|       1|             3|             472500.0|                8907.0|         1.0|            0.0|                1.0|              2.0|            1.0|                 0.0|               1.0|              938.0|                  0.0|\n","|5021310|       0|           1|         0|    0|       0|             2|             270000.0|               16896.0|         1.0|            0.0|                0.0|              0.0|            0.0|                 0.0|               0.0|              141.0|                  1.0|\n","|5021314|       0|           1|         0|    0|       0|             2|             270000.0|               16896.0|         1.0|            0.0|                0.0|              0.0|            0.0|                 1.0|               0.0|              141.0|                  1.0|\n","|5021430|       0|           1|         0|    0|       0|             1|             126000.0|               18907.0|         0.0|            0.0|                0.0|              1.0|            1.0|                 1.0|               0.0|              138.0|                  4.0|\n","|5021431|       0|           1|         0|    0|       0|             1|             126000.0|               18907.0|         0.0|            0.0|                0.0|              1.0|            1.0|                 1.0|               0.0|              138.0|                  4.0|\n","|5021998|       0|           1|         0|    0|       1|             2|              90000.0|               18863.0|         1.0|            0.0|                0.0|              2.0|            0.0|                 0.0|               0.0|              376.0|                  0.0|\n","+-------+--------+------------+----------+-----+--------+--------------+---------------------+----------------------+------------+---------------+-------------------+-----------------+---------------+--------------------+------------------+-------------------+---------------------+\n","only showing top 20 rows\n","\n"]}],"source":["#asignar valores numéricos a las variables categóricas\n","\n","from pyspark.ml.feature import StringIndexer\n","\n","def string_indexer_transform(df, columns):\n","    for column in columns:\n","        indexer = StringIndexer(inputCol=column, outputCol=f\"{column}_index\")\n","        df = indexer.fit(df).transform(df)\n","\n","        df = df.drop(column)\n","\n","    return df\n"]},{"cell_type":"code","source":["#union de los dataframes\n","\n","def inner_join(df_1, df_2, join_type='inner'):\n","    df_joined = df.join(df2, df.Ind_ID == df2.Ind_ID, join_type)\n","    df_joined = df_joined.drop(df2.Ind_ID)\n","    return df_joined\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"p81dldFwoqnI","executionInfo":{"status":"ok","timestamp":1704486196943,"user_tz":360,"elapsed":2251,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"74e1b8a3-831c-4e98-84a2-d3b55086d55c"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+--------+------------+----------+-----+--------+--------------+---------------------+----------------------+------------+---------------+-------------------+-----------------+---------------+--------------------+------------------+-------------------+---------------------+-----+\n","| Ind_ID|CHILDREN|Mobile_phone|Work_Phone|Phone|EMAIL_ID|Family_Members|Annual_income_imputed|Birthday_count_imputed|GENDER_index|Car_Owner_index|Propert_Owner_index|Type_Income_index|EDUCATION_index|Marital_status_index|Housing_type_index|Employed_days_index|Type_Occupation_index|label|\n","+-------+--------+------------+----------+-----+--------+--------------+---------------------+----------------------+------------+---------------+-------------------+-----------------+---------------+--------------------+------------------+-------------------+---------------------+-----+\n","|5008827|       0|           1|         0|    0|       0|             2|             180000.0|               18772.0|         1.0|            1.0|                0.0|              2.0|            1.0|                 0.0|               0.0|                0.0|                  0.0|    1|\n","|5009744|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|    1|\n","|5009746|       0|           1|         1|    1|       0|             2|             315000.0|             16040.342|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|    1|\n","|5009749|       0|           1|         1|    1|       0|             2|            191399.33|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|    1|\n","|5009752|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|    1|\n","|5009753|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              2.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|    1|\n","|5009754|       0|           1|         1|    1|       0|             2|             315000.0|               13557.0|         0.0|            1.0|                1.0|              1.0|            1.0|                 0.0|               0.0|                1.0|                  0.0|    1|\n","|5009894|       0|           1|         0|    0|       0|             2|             180000.0|               22134.0|         0.0|            0.0|                1.0|              2.0|            0.0|                 0.0|               0.0|                0.0|                  0.0|    1|\n","|5010864|       1|           1|         0|    1|       1|             3|             450000.0|               18173.0|         1.0|            1.0|                0.0|              1.0|            0.0|                 0.0|               0.0|               17.0|                  2.0|    1|\n","|5010868|       1|           1|         0|    1|       1|             3|             450000.0|               18173.0|         1.0|            1.0|                0.0|              2.0|            0.0|                 0.0|               0.0|               17.0|                  2.0|    1|\n","|5010869|       1|           1|         0|    1|       1|             1|             450000.0|               18173.0|         1.0|            1.0|                0.0|              1.0|            0.0|                 1.0|               0.0|               17.0|                  2.0|    1|\n","|5018498|       0|           1|         1|    1|       0|             2|              90000.0|               18950.0|         0.0|            1.0|                0.0|              0.0|            0.0|                 0.0|               0.0|               21.0|                 11.0|    1|\n","|5018501|       0|           1|         1|    1|       0|             2|            191399.33|               18950.0|         0.0|            1.0|                0.0|              0.0|            0.0|                 0.0|               0.0|               21.0|                 11.0|    1|\n","|5018503|       0|           1|         1|    1|       0|             2|              90000.0|               18950.0|         0.0|            1.0|                0.0|              0.0|            0.0|                 0.0|               0.0|               21.0|                 11.0|    1|\n","|5021303|       1|           1|         0|    0|       1|             3|             472500.0|                8907.0|         1.0|            0.0|                1.0|              2.0|            1.0|                 0.0|               1.0|              938.0|                  0.0|    1|\n","|5021310|       0|           1|         0|    0|       0|             2|             270000.0|               16896.0|         1.0|            0.0|                0.0|              0.0|            0.0|                 0.0|               0.0|              141.0|                  1.0|    1|\n","|5021314|       0|           1|         0|    0|       0|             2|             270000.0|               16896.0|         1.0|            0.0|                0.0|              0.0|            0.0|                 1.0|               0.0|              141.0|                  1.0|    1|\n","|5021430|       0|           1|         0|    0|       0|             1|             126000.0|               18907.0|         0.0|            0.0|                0.0|              1.0|            1.0|                 1.0|               0.0|              138.0|                  4.0|    1|\n","|5021431|       0|           1|         0|    0|       0|             1|             126000.0|               18907.0|         0.0|            0.0|                0.0|              1.0|            1.0|                 1.0|               0.0|              138.0|                  4.0|    1|\n","|5021998|       0|           1|         0|    0|       1|             2|              90000.0|               18863.0|         1.0|            0.0|                0.0|              2.0|            0.0|                 0.0|               0.0|              376.0|                  0.0|    1|\n","+-------+--------+------------+----------+-----+--------+--------------+---------------------+----------------------+------------+---------------+-------------------+-----------------+---------------+--------------------+------------------+-------------------+---------------------+-----+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["#se cambia el nombre de las columnas\n","\n","def nombre_columnas(df):\n","\n","    df_renamed = df \\\n","        .withColumnRenamed(\"Ind_ID\", \"ID\") \\\n","        .withColumnRenamed(\"CHILDREN\", \"X1\") \\\n","        .withColumnRenamed(\"Mobile_phone\", \"X2\") \\\n","        .withColumnRenamed(\"Work_Phone\", \"X3\") \\\n","        .withColumnRenamed(\"Phone\", \"X4\") \\\n","        .withColumnRenamed(\"EMAIL_ID\", \"X5\") \\\n","        .withColumnRenamed(\"Family_Members\", \"X6\") \\\n","        .withColumnRenamed(\"Annual_income_imputed\", \"X7\") \\\n","        .withColumnRenamed(\"Birthday_count_imputed\", \"X8\") \\\n","        .withColumnRenamed(\"GENDER_index\", \"X9\") \\\n","        .withColumnRenamed(\"Car_Owner_index\", \"X10\") \\\n","        .withColumnRenamed(\"Propert_Owner_index\", \"X11\") \\\n","        .withColumnRenamed(\"Type_Income_index\", \"X12\") \\\n","        .withColumnRenamed(\"EDUCATION_index\", \"X13\") \\\n","        .withColumnRenamed(\"Marital_status_index\", \"X14\") \\\n","        .withColumnRenamed(\"Housing_type_index\", \"X15\") \\\n","        .withColumnRenamed(\"Employed_days_index\", \"X16\") \\\n","        .withColumnRenamed(\"Type_Occupation_index\", \"X17\") \\\n","        .withColumnRenamed(\"label\", \"Y\")\n","\n","    return df_renamed\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"nzvniPIBumXb","executionInfo":{"status":"ok","timestamp":1704486201277,"user_tz":360,"elapsed":2121,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"7763a0e7-ded6-4aa4-91c4-0c4c6c04c124"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+---+---+---+---+---+---+---------+---------+---+---+---+---+---+---+---+-----+----+---+\n","|     ID| X1| X2| X3| X4| X5| X6|       X7|       X8| X9|X10|X11|X12|X13|X14|X15|  X16| X17|  Y|\n","+-------+---+---+---+---+---+---+---------+---------+---+---+---+---+---+---+---+-----+----+---+\n","|5008827|  0|  1|  0|  0|  0|  2| 180000.0|  18772.0|1.0|1.0|0.0|2.0|1.0|0.0|0.0|  0.0| 0.0|  1|\n","|5009744|  0|  1|  1|  1|  0|  2| 315000.0|  13557.0|0.0|1.0|1.0|1.0|1.0|0.0|0.0|  1.0| 0.0|  1|\n","|5009746|  0|  1|  1|  1|  0|  2| 315000.0|16040.342|0.0|1.0|1.0|1.0|1.0|0.0|0.0|  1.0| 0.0|  1|\n","|5009749|  0|  1|  1|  1|  0|  2|191399.33|  13557.0|0.0|1.0|1.0|1.0|1.0|0.0|0.0|  1.0| 0.0|  1|\n","|5009752|  0|  1|  1|  1|  0|  2| 315000.0|  13557.0|0.0|1.0|1.0|1.0|1.0|0.0|0.0|  1.0| 0.0|  1|\n","|5009753|  0|  1|  1|  1|  0|  2| 315000.0|  13557.0|0.0|1.0|1.0|2.0|1.0|0.0|0.0|  1.0| 0.0|  1|\n","|5009754|  0|  1|  1|  1|  0|  2| 315000.0|  13557.0|0.0|1.0|1.0|1.0|1.0|0.0|0.0|  1.0| 0.0|  1|\n","|5009894|  0|  1|  0|  0|  0|  2| 180000.0|  22134.0|0.0|0.0|1.0|2.0|0.0|0.0|0.0|  0.0| 0.0|  1|\n","|5010864|  1|  1|  0|  1|  1|  3| 450000.0|  18173.0|1.0|1.0|0.0|1.0|0.0|0.0|0.0| 17.0| 2.0|  1|\n","|5010868|  1|  1|  0|  1|  1|  3| 450000.0|  18173.0|1.0|1.0|0.0|2.0|0.0|0.0|0.0| 17.0| 2.0|  1|\n","|5010869|  1|  1|  0|  1|  1|  1| 450000.0|  18173.0|1.0|1.0|0.0|1.0|0.0|1.0|0.0| 17.0| 2.0|  1|\n","|5018498|  0|  1|  1|  1|  0|  2|  90000.0|  18950.0|0.0|1.0|0.0|0.0|0.0|0.0|0.0| 21.0|11.0|  1|\n","|5018501|  0|  1|  1|  1|  0|  2|191399.33|  18950.0|0.0|1.0|0.0|0.0|0.0|0.0|0.0| 21.0|11.0|  1|\n","|5018503|  0|  1|  1|  1|  0|  2|  90000.0|  18950.0|0.0|1.0|0.0|0.0|0.0|0.0|0.0| 21.0|11.0|  1|\n","|5021303|  1|  1|  0|  0|  1|  3| 472500.0|   8907.0|1.0|0.0|1.0|2.0|1.0|0.0|1.0|938.0| 0.0|  1|\n","|5021310|  0|  1|  0|  0|  0|  2| 270000.0|  16896.0|1.0|0.0|0.0|0.0|0.0|0.0|0.0|141.0| 1.0|  1|\n","|5021314|  0|  1|  0|  0|  0|  2| 270000.0|  16896.0|1.0|0.0|0.0|0.0|0.0|1.0|0.0|141.0| 1.0|  1|\n","|5021430|  0|  1|  0|  0|  0|  1| 126000.0|  18907.0|0.0|0.0|0.0|1.0|1.0|1.0|0.0|138.0| 4.0|  1|\n","|5021431|  0|  1|  0|  0|  0|  1| 126000.0|  18907.0|0.0|0.0|0.0|1.0|1.0|1.0|0.0|138.0| 4.0|  1|\n","|5021998|  0|  1|  0|  0|  1|  2|  90000.0|  18863.0|1.0|0.0|0.0|2.0|0.0|0.0|0.0|376.0| 0.0|  1|\n","+-------+---+---+---+---+---+---+---------+---------+---+---+---+---+---+---+---+-----+----+---+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["from pyspark.ml.feature import VectorAssembler\n","from pyspark.ml.feature import StandardScaler\n","from pyspark.ml import Pipeline\n","\n","\n","# Función de ensamblaje de características\n","def vector_assembler(df, input_cols, output_col=\"features\"):\n","    assembler = VectorAssembler(inputCols=input_cols, outputCol=output_col)\n","    assembled_df = assembler.transform(df)\n","    return assembled_df\n","\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"k9Y4UQGLHO4z","executionInfo":{"status":"ok","timestamp":1704486214105,"user_tz":360,"elapsed":2230,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"44688192-0c4e-49d0-8406-cfb5311e860a"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+----------------------------------------------------------------------------------+---+\n","|features                                                                          |Y  |\n","+----------------------------------------------------------------------------------+---+\n","|(16,[1,5,6,7,8,9,10,11],[1.0,2.0,180000.0,18772.0,1.0,1.0,2.0,1.0])               |1  |\n","|[0.0,1.0,1.0,1.0,0.0,2.0,315000.0,13557.0,0.0,1.0,1.0,1.0,0.0,0.0,1.0,0.0]        |1  |\n","|[0.0,1.0,1.0,1.0,0.0,2.0,315000.0,16040.341796875,0.0,1.0,1.0,1.0,0.0,0.0,1.0,0.0]|1  |\n","|[0.0,1.0,1.0,1.0,0.0,2.0,191399.328125,13557.0,0.0,1.0,1.0,1.0,0.0,0.0,1.0,0.0]   |1  |\n","|[0.0,1.0,1.0,1.0,0.0,2.0,315000.0,13557.0,0.0,1.0,1.0,1.0,0.0,0.0,1.0,0.0]        |1  |\n","|[0.0,1.0,1.0,1.0,0.0,2.0,315000.0,13557.0,0.0,1.0,2.0,1.0,0.0,0.0,1.0,0.0]        |1  |\n","|[0.0,1.0,1.0,1.0,0.0,2.0,315000.0,13557.0,0.0,1.0,1.0,1.0,0.0,0.0,1.0,0.0]        |1  |\n","|(16,[1,5,6,7,10],[1.0,2.0,180000.0,22134.0,2.0])                                  |1  |\n","|[1.0,1.0,0.0,1.0,1.0,3.0,450000.0,18173.0,1.0,1.0,1.0,0.0,0.0,0.0,17.0,2.0]       |1  |\n","|[1.0,1.0,0.0,1.0,1.0,3.0,450000.0,18173.0,1.0,1.0,2.0,0.0,0.0,0.0,17.0,2.0]       |1  |\n","|[1.0,1.0,0.0,1.0,1.0,1.0,450000.0,18173.0,1.0,1.0,1.0,0.0,1.0,0.0,17.0,2.0]       |1  |\n","|(16,[1,2,3,5,6,7,9,14,15],[1.0,1.0,1.0,2.0,90000.0,18950.0,1.0,21.0,11.0])        |1  |\n","|(16,[1,2,3,5,6,7,9,14,15],[1.0,1.0,1.0,2.0,191399.328125,18950.0,1.0,21.0,11.0])  |1  |\n","|(16,[1,2,3,5,6,7,9,14,15],[1.0,1.0,1.0,2.0,90000.0,18950.0,1.0,21.0,11.0])        |1  |\n","|[1.0,1.0,0.0,0.0,1.0,3.0,472500.0,8907.0,1.0,0.0,2.0,1.0,0.0,1.0,938.0,0.0]       |1  |\n","|(16,[1,5,6,7,8,14,15],[1.0,2.0,270000.0,16896.0,1.0,141.0,1.0])                   |1  |\n","|(16,[1,5,6,7,8,12,14,15],[1.0,2.0,270000.0,16896.0,1.0,1.0,141.0,1.0])            |1  |\n","|(16,[1,5,6,7,10,11,12,14,15],[1.0,1.0,126000.0,18907.0,1.0,1.0,1.0,138.0,4.0])    |1  |\n","|(16,[1,5,6,7,10,11,12,14,15],[1.0,1.0,126000.0,18907.0,1.0,1.0,1.0,138.0,4.0])    |1  |\n","|(16,[1,4,5,6,7,8,10,14],[1.0,1.0,2.0,90000.0,18863.0,1.0,2.0,376.0])              |1  |\n","+----------------------------------------------------------------------------------+---+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["\n","def scaler(df, input_col, output_col):\n","\n","    scaler = StandardScaler(inputCol=input_col, outputCol=output_col, withMean=True, withStd=True)\n","    pipeline = Pipeline(stages=[scaler])\n","    model = pipeline.fit(df)\n","    df_scalado = model.transform(df)\n","\n","    return df_scalado\n","\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"hfl3Dc-iBopA","executionInfo":{"status":"ok","timestamp":1704486218650,"user_tz":360,"elapsed":2476,"user":{"displayName":"Gabriel Valentine","userId":"12394259087128045623"}},"outputId":"fab135f0-79d2-4ac0-e77d-62edc1f3a487"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["+--------------------+---+--------------------+\n","|            features|  Y|     scaled_features|\n","+--------------------+---+--------------------+\n","|(16,[1,5,6,7,8,9,...|  1|[-0.5314733233858...|\n","|[0.0,1.0,1.0,1.0,...|  1|[-0.5314733233858...|\n","|[0.0,1.0,1.0,1.0,...|  1|[-0.5314733233858...|\n","|[0.0,1.0,1.0,1.0,...|  1|[-0.5314733233858...|\n","|[0.0,1.0,1.0,1.0,...|  1|[-0.5314733233858...|\n","|[0.0,1.0,1.0,1.0,...|  1|[-0.5314733233858...|\n","|[0.0,1.0,1.0,1.0,...|  1|[-0.5314733233858...|\n","|(16,[1,5,6,7,10],...|  1|[-0.5314733233858...|\n","|[1.0,1.0,0.0,1.0,...|  1|[0.75603951636578...|\n","|[1.0,1.0,0.0,1.0,...|  1|[0.75603951636578...|\n","|[1.0,1.0,0.0,1.0,...|  1|[0.75603951636578...|\n","|(16,[1,2,3,5,6,7,...|  1|[-0.5314733233858...|\n","|(16,[1,2,3,5,6,7,...|  1|[-0.5314733233858...|\n","|(16,[1,2,3,5,6,7,...|  1|[-0.5314733233858...|\n","|[1.0,1.0,0.0,0.0,...|  1|[0.75603951636578...|\n","|(16,[1,5,6,7,8,14...|  1|[-0.5314733233858...|\n","|(16,[1,5,6,7,8,12...|  1|[-0.5314733233858...|\n","|(16,[1,5,6,7,10,1...|  1|[-0.5314733233858...|\n","|(16,[1,5,6,7,10,1...|  1|[-0.5314733233858...|\n","|(16,[1,4,5,6,7,8,...|  1|[-0.5314733233858...|\n","+--------------------+---+--------------------+\n","only showing top 20 rows\n","\n"]}]}],"metadata":{"colab":{"provenance":[],"authorship_tag":"ABX9TyMi36GsFRCbtmUtCAnMQHUm"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}